<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innerverse Global Chat</title>
<style>
  :root{
    --accent:#2dd4bf;          /* teal modern */
    --accent2:#60a5fa;         /* blue highlight */
    --bg:#0b0f14;              /* app background */
    --panel:#0f1720;           /* chat panel */
    --header:#0c141b;          /* header */
    --border:rgba(255,255,255,.08);
    --text:#e6edf3;
    --muted:rgba(230,237,243,.65);

    --bubble-me: linear-gradient(135deg, rgba(45,212,191,.95), rgba(96,165,250,.85));
    --bubble-other: rgba(255,255,255,.07);

    --shadow: 0 12px 40px rgba(0,0,0,.55);
    --shadow-soft: 0 8px 18px rgba(0,0,0,.35);
    --radius: 18px;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }

  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    background:
      radial-gradient(1200px 600px at 30% 0%, rgba(96,165,250,.12), transparent 55%),
      radial-gradient(900px 500px at 90% 20%, rgba(45,212,191,.10), transparent 60%),
      var(--bg);
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
  }

  #app-container{
    width:min(980px, 100%);
    max-width: 520px;         /* mobile-first */
    height:min(92vh, 820px);
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid var(--border);
    border-radius: 26px;
    overflow:hidden;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    display:flex;
    flex-direction:column;
  }

  /* LOGIN */
  #login-screen{
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:14px;
    padding:28px;
    text-align:center;
  }
  #login-screen h1{
    margin:0;
    font-size:34px;
    letter-spacing:.2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
  }
  #login-screen p{
    margin:0;
    color:var(--muted);
    font-size:14px;
  }

  .google-btn{
    width: min(340px, 100%);
    background: rgba(255,255,255,.92);
    color:#0b0f14;
    padding:12px 16px;
    border-radius: 14px;
    border: 0;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    font-weight: 700;
    box-shadow: var(--shadow-soft);
    transition: transform .12s ease, filter .12s ease;
  }
  .google-btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
  .google-btn:active{ transform: translateY(0px) scale(.99); }

  /* CHAT */
  #chat-screen{
    display:none;
    height:100%;
    flex-direction:column;
    background: var(--panel);
  }

  header{
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border-bottom: 1px solid var(--border);
    padding: 14px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  #userName{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:800;
    font-size:14px;
    letter-spacing:.2px;
  }

  /* avatar bubble */
  #userName::before{
    content:"";
    width:34px;height:34px;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(45,212,191,.8), rgba(96,165,250,.75));
    box-shadow: 0 8px 16px rgba(0,0,0,.35);
    display:inline-block;
  }

  #logoutBtn{
    background: rgba(255,255,255,.06);
    border: 1px solid var(--border);
    color: rgba(255,85,85,.95);
    padding: 8px 12px;
    border-radius: 12px;
    cursor:pointer;
    font-weight:700;
    transition: background .12s ease, transform .12s ease;
  }
  #logoutBtn:hover{ background: rgba(255,255,255,.09); }
  #logoutBtn:active{ transform: scale(.99); }

  /* messages area with subtle pattern */
  #messages{
    flex:1;
    padding: 16px 14px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap: 10px;

    background:
      radial-gradient(circle at 20% 0%, rgba(45,212,191,.08), transparent 35%),
      radial-gradient(circle at 90% 20%, rgba(96,165,250,.07), transparent 40%),
      repeating-linear-gradient(45deg, rgba(255,255,255,.03) 0 2px, transparent 2px 10px);
    background-blend-mode: screen;
  }

  /* nicer scrollbar */
  #messages::-webkit-scrollbar{ width:10px; }
  #messages::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,.10);
    border-radius: 999px;
    border: 2px solid rgba(0,0,0,0);
    background-clip: padding-box;
  }

  .msg{
    max-width: 82%;
    padding: 10px 12px;
    border-radius: 18px;
    background: var(--bubble-other);
    border: 1px solid rgba(255,255,255,.06);
    box-shadow: 0 10px 22px rgba(0,0,0,.25);
    align-self:flex-start;
    position:relative;
    overflow:hidden;
  }

  /* bubble “tail” */
  .msg::after{
    content:"";
    position:absolute;
    left:-6px;
    bottom:10px;
    width:14px;height:14px;
    background: var(--bubble-other);
    border-left: 1px solid rgba(255,255,255,.06);
    border-bottom: 1px solid rgba(255,255,255,.06);
    transform: rotate(45deg);
  }

  .msg.me{
    align-self:flex-end;
    background: var(--bubble-me);
    color: #07111a;
    border: 0;
  }
  .msg.me::after{
    left:auto;
    right:-6px;
    background: linear-gradient(135deg, rgba(45,212,191,.95), rgba(96,165,250,.85));
    border:0;
    transform: rotate(45deg);
  }

  .sender{
    display:block;
    font-size: 11px;
    font-weight: 800;
    color: rgba(230,237,243,.75);
    margin-bottom: 4px;
    letter-spacing:.2px;
  }
  .msg.me .sender{ color: rgba(7,17,26,.75); }

  .msg .text{
    font-size: 14px;
    line-height: 1.35;
    white-space: pre-wrap;
  }

  /* timestamp (optional) */
  .meta{
    margin-top:6px;
    display:flex;
    justify-content:flex-end;
    font-size: 11px;
    color: rgba(230,237,243,.55);
  }
  .msg.me .meta{ color: rgba(7,17,26,.65); }

  /* input bar like WhatsApp */
  #input-area{
    padding: 12px;
    border-top: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    display:flex;
    gap: 10px;
    align-items:center;
  }

  #msgInput{
    flex:1;
    padding: 12px 14px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.25);
    color: var(--text);
    outline:none;
    font-size: 14px;
    transition: border-color .12s ease, box-shadow .12s ease;
  }
  #msgInput:focus{
    border-color: rgba(45,212,191,.55);
    box-shadow: 0 0 0 3px rgba(45,212,191,.15);
  }

  #sendBtn{
    width:44px;height:44px;
    border-radius: 999px;
    border: 0;
    cursor:pointer;
    color:#041018;
    background: linear-gradient(135deg, rgba(45,212,191,.95), rgba(96,165,250,.90));
    box-shadow: 0 10px 22px rgba(0,0,0,.35);
    font-size: 16px;
    transition: transform .12s ease, filter .12s ease;
  }
  #sendBtn:hover{ transform: translateY(-1px); filter: brightness(1.03); }
  #sendBtn:active{ transform: translateY(0px) scale(.99); }

  /* Responsive tweaks */
  @media (max-width: 420px){
    #app-container{ border-radius: 22px; }
    .msg{ max-width: 88%; }
  }
</style>
</head>
<body>

<div id="app-container">
    <div id="login-screen">
        <h1 style="color: var(--primary); margin:0;">innerverse</h1>
        <p>Community Chat</p>
        <button class="google-btn" id="loginBtn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
            Login with Google
        </button>
    </div>

    <div id="chat-screen">
        <header>
            <span id="userName" style="font-size: 14px; font-weight: bold;"></span>
            <button id="logoutBtn" style="background:transparent; color:#ff4444; border:none; cursor:pointer;">Logout</button>
        </header>
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="msgInput" placeholder="Tulis pesan..." autocomplete="off">
            <button id="sendBtn">➤</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, serverTimestamp, query, limitToLast, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // --- CONFIGURASI ANDA ---
const firebaseConfig = {
  apiKey: "AIzaSyDGwFXEHRArBauIOksrGmCgbC1fpVLkfMk",
  authDomain: "globalchat-innerverse.firebaseapp.com",
  databaseURL: "https://globalchat-innerverse-default-rtdb.firebaseio.com",
  projectId: "globalchat-innerverse",
  storageBucket: "globalchat-innerverse.firebasestorage.app",
  messagingSenderId: "20520942010",
  appId: "1:20520942010:web:9d65b58ce00b2df9834583",
  measurementId: "G-ZFW3JJNGS5"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const chatRef = ref(db, 'chats');

  let currentUser = null;
  let chatInitialized = false;

  // --- AUTH LOGIC ---
  document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider).catch(err => console.error(err));
  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    const loginScreen = document.getElementById('login-screen');
    const chatScreen = document.getElementById('chat-screen');
    const messagesDiv = document.getElementById('messages');

    if (user) {
      currentUser = user;
      document.getElementById('userName').textContent = user.displayName;
      loginScreen.style.display = 'none';
      chatScreen.style.display = 'flex';
      
      // Jalankan listener pesan HANYA JIKA sudah login
      if (!chatInitialized) {
        startChatListener();
        chatInitialized = true;
      }
    } else {
      currentUser = null;
      chatInitialized = false;
      loginScreen.style.display = 'flex';
      chatScreen.style.display = 'none';
      messagesDiv.innerHTML = ''; // Hapus pesan dari layar saat logout
      off(chatRef); // Matikan listener agar tidak memakan memori
    }
  });

  // --- CHAT LOGIC ---
  function startChatListener() {
    const q = query(chatRef, limitToLast(50));
    
    onChildAdded(q, (snapshot) => {
      const data = snapshot.val();
      renderMessage(data);
    });
  }

function renderMessage(data) {
  const messagesDiv = document.getElementById('messages');
  const div = document.createElement('div');
  div.classList.add('msg');

  if (currentUser && data.uid === currentUser.uid) {
    div.classList.add('me');
  }

  const sender = document.createElement('span');
  sender.className = 'sender';
  sender.textContent = data.sender || 'Anonymous';

  const text = document.createElement('span');
  text.className = 'text';
  text.textContent = data.text;

  // timestamp (fallback jika belum ada)
  const meta = document.createElement('div');
  meta.className = 'meta';
  const time = document.createElement('span');

  const ts = data.timestamp;
  let date = null;
  if (typeof ts === 'number') date = new Date(ts);
  // kalau RTDB ngasih object, biasanya sudah berubah jadi number setelah tersimpan;
  // saat pertama render dari cache bisa null → fallback
  time.textContent = date
    ? date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
    : '';

  meta.appendChild(time);

  div.appendChild(sender);
  div.appendChild(text);
  div.appendChild(meta);

  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
  const sendMsg = () => {
    const input = document.getElementById('msgInput');
    const val = input.value.trim();
    if (val && currentUser) {
      push(chatRef, {
        text: val,
        sender: currentUser.displayName,
        uid: currentUser.uid,
        timestamp: serverTimestamp()
      });
      input.value = '';
    }
  };

  document.getElementById('sendBtn').onclick = sendMsg;
  document.getElementById('msgInput').onkeypress = (e) => { if(e.key === 'Enter') sendMsg(); };
</script>

</body>
</html>
